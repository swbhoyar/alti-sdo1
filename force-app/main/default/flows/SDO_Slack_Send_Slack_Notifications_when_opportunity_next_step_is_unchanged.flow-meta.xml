<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <description>Sends a Slack notification to the user who owns the current opportunity with an outdated next step.</description>
        <name>SendNextStepNotifications</name>
        <label>Send Next Step Notifications</label>
        <locationX>440</locationX>
        <locationY>1200</locationY>
        <actionName>next_step_reminder</actionName>
        <actionType>sendNotification</actionType>
        <connector>
            <targetReference>AddOpportunityToSentNotifications</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>recordId</name>
            <value>
                <elementReference>OpportunityHistoryLoop.OpportunityId</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>recipientIds</name>
            <value>
                <elementReference>RecipientIds</elementReference>
            </value>
        </inputParameters>
        <nameSegment>next_step_reminder</nameSegment>
        <versionSegment>1</versionSegment>
    </actionCalls>
    <apiVersion>59.0</apiVersion>
    <assignments>
        <description>Adds the ID for the current opportunity with updated next steps to the NextStepUpdatedOpportunityIds collection variable.</description>
        <name>AddOpportunityIds</name>
        <label>Add Opportunities to Collection</label>
        <locationX>264</locationX>
        <locationY>684</locationY>
        <assignmentItems>
            <assignToReference>NextStepUpdatedOpportunityIds</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>IterateThroughFilteredOpportunities.OpportunityId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>IterateThroughFilteredOpportunities</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Adds the opportunity ID to the OpportunityIdsForSentNotifications collection variable.</description>
        <name>AddOpportunityToSentNotifications</name>
        <label>Add Opportunity to Sent Notifications Collection</label>
        <locationX>440</locationX>
        <locationY>1308</locationY>
        <assignmentItems>
            <assignToReference>OpportunityIdsForSentNotifications</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>OpportunityHistoryLoop.OpportunityId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>OpportunityHistoryLoop</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Adds the users to receive notifications to the RecipientIds collection variable.</description>
        <name>AddRecipientIds</name>
        <label>Add Users to RecipientIds</label>
        <locationX>440</locationX>
        <locationY>1092</locationY>
        <assignmentItems>
            <assignToReference>RecipientIds</assignToReference>
            <operator>RemoveAll</operator>
            <value>
                <elementReference>RecipientIds</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>RecipientIds</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>OpportunityHistoryLoop.Opportunity.OwnerId</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>SendNextStepNotifications</targetReference>
        </connector>
    </assignments>
    <assignments>
        <description>Sets NextStepLastChanged to the date at runtime less DaysAfterLastChange. Sets DayAfterNextStepLastChanged to the day after NextStepLastChanged.</description>
        <name>SetNextStepUnchangedVariables</name>
        <label>Set Next Step Unchanged Variables</label>
        <locationX>176</locationX>
        <locationY>252</locationY>
        <assignmentItems>
            <assignToReference>NextStepLastChanged</assignToReference>
            <operator>Subtract</operator>
            <value>
                <elementReference>DaysAfterLastChange</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>DayAfterNextStepLastChanged</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>NextStepLastChanged</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>DayAfterNextStepLastChanged</assignToReference>
            <operator>Add</operator>
            <value>
                <numberValue>1.0</numberValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>GetOpportunityFieldHistories</targetReference>
        </connector>
    </assignments>
    <collectionProcessors>
        <description>Filter opportunities that have changed next steps within the period specified in DaysAfterLastChange.</description>
        <name>FilterUpdatedOpportunities</name>
        <elementSubtype>FilterCollectionProcessor</elementSubtype>
        <label>Filter Opportunities with Updated Next Steps</label>
        <locationX>176</locationX>
        <locationY>468</locationY>
        <assignNextValueToReference>currentItem_FilterUpdatedOpportunities</assignNextValueToReference>
        <collectionProcessorType>FilterCollectionProcessor</collectionProcessorType>
        <collectionReference>GetOpportunityFieldHistories</collectionReference>
        <conditionLogic>and</conditionLogic>
        <conditions>
            <leftValueReference>currentItem_FilterUpdatedOpportunities.CreatedDate</leftValueReference>
            <operator>GreaterThanOrEqualTo</operator>
            <rightValue>
                <elementReference>DayAfterNextStepLastChanged</elementReference>
            </rightValue>
        </conditions>
        <conditions>
            <leftValueReference>currentItem_FilterUpdatedOpportunities.Field</leftValueReference>
            <operator>EqualTo</operator>
            <rightValue>
                <stringValue>NextStep</stringValue>
            </rightValue>
        </conditions>
        <connector>
            <targetReference>IterateThroughFilteredOpportunities</targetReference>
        </connector>
    </collectionProcessors>
    <decisions>
        <description>Determines whether to send a notification for the opportunity. If the opportunity next step was recently updated, the opportunity is closed, or the notification was already sent, then no notification is sent.</description>
        <name>SendNotification</name>
        <label>Send Notification?</label>
        <locationX>352</locationX>
        <locationY>984</locationY>
        <defaultConnector>
            <targetReference>AddRecipientIds</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Yes (Default)</defaultConnectorLabel>
        <rules>
            <name>NoNotification</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>NextStepUpdatedOpportunityIds</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>OpportunityHistoryLoop.OpportunityId</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>OpportunityHistoryLoop.Opportunity.IsClosed</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>OpportunityIdsForSentNotifications</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <elementReference>OpportunityHistoryLoop.OpportunityId</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>OpportunityHistoryLoop.Opportunity.Owner.IsActive</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>OpportunityHistoryLoop</targetReference>
            </connector>
            <label>No</label>
        </rules>
    </decisions>
    <environments>Default</environments>
    <interviewLabel>Send Slack Notifications when opportunity next step is unchanged {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Send Slack Notifications when opportunity next step is unchanged</label>
    <loops>
        <description>Repeats actions in the loop for the filtered opportunities to get opportunities that were updated after the NextStepChangeDate.</description>
        <name>IterateThroughFilteredOpportunities</name>
        <label>Iterate Through Filtered Opportunities</label>
        <locationX>176</locationX>
        <locationY>576</locationY>
        <collectionReference>FilterUpdatedOpportunities</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>AddOpportunityIds</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>OpportunityHistoryLoop</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <description>Iterate through opportunity field history records returned from the GetOpportunityFieldHistories element.</description>
        <name>OpportunityHistoryLoop</name>
        <label>Opportunity History Loop</label>
        <locationX>176</locationX>
        <locationY>876</locationY>
        <collectionReference>GetOpportunityFieldHistories</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>SendNotification</targetReference>
        </nextValueConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <description>Gets opportunity field history records that were created on or after NotificationDate and stores the results in the Opportunity Field History from GetOpportunityFieldHistories record collection variable.</description>
        <name>GetOpportunityFieldHistories</name>
        <label>Get Opportunity Field Histories</label>
        <locationX>176</locationX>
        <locationY>360</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>FilterUpdatedOpportunities</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Field</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>NextStep</stringValue>
            </value>
        </filters>
        <filters>
            <field>CreatedDate</field>
            <operator>GreaterThanOrEqualTo</operator>
            <value>
                <elementReference>NextStepLastChanged</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>OpportunityFieldHistory</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <sourceTemplate>sales_channel__OpptyNextStepNotif</sourceTemplate>
    <start>
        <locationX>50</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>SetNextStepUnchangedVariables</targetReference>
        </connector>
        <schedule>
            <frequency>Daily</frequency>
            <startDate>2021-12-22</startDate>
            <startTime>06:01:00.000Z</startTime>
        </schedule>
        <triggerType>Scheduled</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>currentItem_FilterUpdatedOpportunities</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OpportunityFieldHistory</objectType>
    </variables>
    <variables>
        <description>Stores the date for the day after NextStepLastChanged. If no change has been made to next step between the last change and this date, the owner is to be notified.</description>
        <name>DayAfterNextStepLastChanged</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <elementReference>$Flow.CurrentDate</elementReference>
        </value>
    </variables>
    <variables>
        <description>Stores the number of days that can elapse after the last change was made to an opportunity record before the next notification is sent. To notify record owners earlier or later, change this value.</description>
        <name>DaysAfterLastChange</name>
        <dataType>Number</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <scale>0</scale>
        <value>
            <numberValue>30.0</numberValue>
        </value>
    </variables>
    <variables>
        <description>Initially set to today&apos;s date, and updated to the last date that an opportunity&apos;s Next Step field was changed.</description>
        <name>NextStepLastChanged</name>
        <dataType>Date</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <value>
            <elementReference>$Flow.CurrentDate</elementReference>
        </value>
    </variables>
    <variables>
        <description>Stores IDs of the opportunities where the next step was updated after the NextStepChangeDate.</description>
        <name>NextStepUpdatedOpportunityIds</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>Stores the list of opportunities that have already had a next step reminder sent to the owner.</description>
        <name>OpportunityIdsForSentNotifications</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <description>Stores IDs of recipients to receive notifications for an opportunity with an unchanged next step.</description>
        <name>RecipientIds</name>
        <dataType>String</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
